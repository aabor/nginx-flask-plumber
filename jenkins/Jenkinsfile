pipeline {
    agent any
    environment {
        USER=credentials('jenkins-current-user')
        SOURCE_CODE="nginx-flask-plumber"
        FH_DATA="/home/$USER/Documents/Trading/fh_data"
        DOCKER_CREDS=credentials('jenkins-docker-credentials')
        RSTUDIO_COMMON_CREDS = credentials('jenkins-rstudio-common-creds')    
        UID = "${env.UID}"
    }    
    stages {
        stage('checkout'){
            steps{
                echo 'Changing permissions so that docker can save rest reports'
                sh 'echo "${BUILD_USER}"'
                sh 'echo "${BUILD_USER_ID}"'
                sh 'echo "${BUILD_USER_EMAIL}"'
                sh '''
                    #chmod 777 test-reports
                    export UID=$(id -u)
                    echo "UID is $UID"
                    echo 'listing permissions'
                    ls -l
                '''
            }
        }
        stage('Developer'){
            environment { 
                FH_NAMESPACE="-dev"
                DATA="$FH_DATA$FH_NAMESPACE"
                NEWS="/home/$USER/Dropbox/news/data$FH_NAMESPACE"
            }            
            steps {
                echo 'Testing pnews...'
                sh '''
                    export GIT_VERSION=$(git describe --tags | sed s/v//)
                    docker-compose -f docker-compose-test.yml up pnews
                '''
                echo 'Testing rnews...'
                sh '''
                    export GIT_VERSION=$(git describe --tags | sed s/v//)
                    docker-compose -f docker-compose-test.yml up rnews
                '''
                sh'''
                    echo "Listing reports"
                    ls -l test-reports
                '''
            }
        }
        stage('Functional tests') {
            environment { 
                FH_NAMESPACE="-test"
                DATA="$FH_DATA$FH_NAMESPACE"
            }            
            steps {
                echo 'Testing'
                sh '''
                    export GIT_VERSION=$(git describe --tags | sed s/v//)
                '''
            }
            post {
                always{
                    junit '**/test-reports/*.xml'
                    cleanWs()
                    sh '''
                        pwd
                        ls
                        echo "Finishing.."
                    '''
                }
            }
        }
    }
}
