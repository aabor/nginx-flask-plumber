pipeline {
    agent any
    environment {
        USER=credentials('jenkins-current-user')
        DOCKER_CREDS=credentials('jenkins-docker-credentials')
        RSTUDIO_COMMON_CREDS = credentials('jenkins-rstudio-common-creds')    
    }    
    stages {
        stage('Developer'){
            steps {
                sh'''
                echo "Changing permissions for test reports"
                chmod 777 pnews/test-reports
                chmod 777 rnews/tests/testthat/test-reports
                '''
                echo 'Testing'
                sh '''
                    docker-compose down
                    export GIT_VERSION=$(git describe --tags | sed s/v//)
                    docker-compose -f docker-compose.yml up -d
                    docker-compose -f docker-compose.test.yml up
                    docker-compose -f docker-compose.yml down
                '''
            }
        }
        stage('Functional tests') {
            steps {
                echo 'Testing'
                sh '''
                    export GIT_VERSION=$(git describe --tags | sed s/v//)
                '''
            }
            post {
                always{
                    junit '**/test-reports/*.xml'
                    cleanWs()
                    sh '''
                        pwd
                        ls
                        echo "Finishing.."
                    '''
                }
            }
        }
    }
}
